{% extends 'base.html' %}
{% load static %}
{% block bodyblock %}

   <!-- Start Page Title Area -->
   <div class="page-title-area">
        <div class="container">
            <ul>
                <li><a href="#">Home</a></li>
                <li>Product</li>
            </ul>
        </div>
    </div>
    <!-- End Page Title Area -->


 <!-- Start Collections Area -->
 <section class="products-collections-area ptb-60">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <div class="contain">
                    <img src="{{imagepath}}" style="width: 50%">
                    <div class="filters">
                        <div class="filter">
                            <label for="saturation">Saturation</label>
                            <div class="input">
                                <input type="range" min="0" max="200" class="filter_input_width" id="saturation" value="100"
                                    oninput="this.nextElementSibling.value = this.value">
                                <output>100</output>
                            </div>
                        </div>
                        <div class="filter">
                            <label for="blur">Blur</label>
                            <div class="input">
                                <input type="range" min="0" max="10" class="filter_input_width" id="blur" value="0"
                                    oninput="this.nextElementSibling.value = this.value">
                                <output>0</output>
                            </div>
                        </div>
                        <div class="filter">
                            <label for="brightness">Brightness</label>
                            <div class="input">
                                <input type="range" min="0" max="200" class="filter_input_width" id="brightness" value="100"
                                    oninput="this.nextElementSibling.value = this.value">
                                <output>100</output>
                            </div>
                        </div>
                        <div class="filter">
                            <label for="contrast">Contrast</label>
                            <div class="input">
                                <input type="range" min="0" max="200" class="filter_input_width" id="contrast" value="100"
                                    oninput="this.nextElementSibling.value = this.value">
                                <output>100</output>
                            </div>
                        </div>

                        <div class="filter">
                            <label for="contrast">Ambient Light</label>
                            <div class="input">
                                <input type="range" min="0" max="100" class="filter_input_width" id="AmbientLight" value="2"
                                    oninput="this.nextElementSibling.value = this.value">
                                <output>100</output>
                            </div>
                        </div>

                        <div style="display:flex; gap:30px">
                            <button class="resetBtn btn btn-dark rounded">Reset</button>
                            <button id="capture-btn" class="btn btn-dark rounded"> Capture </button> 
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">

                <canvas class="webgl"></canvas>

            </div>
        </div>
    </div>
</section>
<!-- End Collections Area -->




{% endblock %}

{% block jsBlock %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r126/three.min.js"></script>
<script src="https://unpkg.com/three@0.126.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>

    $(document).ready(function () {
        
        const imgEl = $("img");
        const filtersEl = $("input[type=range]");
        const anglesEl = $("li");
        const fileEl = $(".file");
        const chooseBtnEl = $(".chooseBtn");
        const saveBtnEl = $(".saveBtn");
        const resetBtnEl = $(".resetBtn");

        let saturation = "100", blur = "0", brightness = "100", contrast = "100";

        let rotate = 0, flipH = 1, flipV = 1;
        
        const loadEl = () => {
            filtersEl.eq(0).val("100");
            filtersEl.eq(1).val("0");
            filtersEl.eq(2).val("100");
            filtersEl.eq(3).val("100");
        }

        const generateResult = () => {
            imgEl.css("filter", `saturate(${saturation}%) blur(${blur}px) brightness(${brightness}%) contrast(${contrast}%)`);
        }

        filtersEl.on("input", function () {
            const id = $(this).attr("id");
            if (id === "saturation") {
                saturation = filtersEl.eq(0).val();
            } else if (id === "blur") {
                blur = filtersEl.eq(1).val();
            } else if (id === "brightness") {
                brightness = filtersEl.eq(2).val();
            } else {
                contrast = filtersEl.eq(3).val();
            }
            generateResult();
        });

        resetBtnEl.click(function () {
            saturation = "100", blur = "0", brightness = "100", contrast = "100";
            // Reset the output values
            $(".filter input[type=range]").each(function () {
                $(this).next("output").text($(this).attr("value"));
            });
            generateResult();
            loadEl();
        });

        loadEl();
    });

</script>

<script type="text/javascript"> window.CSRF_TOKEN = "{{ csrf_token }}"; </script>

<script>

    const canvasContainer = document.querySelector('.col-md-6');
    const canvas = document.querySelector('.webgl');
    const canvasWidth = canvasContainer.clientWidth;
    const canvasHeight = canvasContainer.clientHeight;
    canvas.width = canvasWidth;
    canvas.height = canvasHeight;
    const scene = new THREE.Scene();
    const loader = new THREE.GLTFLoader();
    let model;

    const AmbientLightId = document.getElementById("AmbientLight");
    let amblight = 2;
    let ambientLight;

    AmbientLightId.addEventListener("input", function () {
        amblight = parseInt(this.value);
        updateAmbientLight();
    });

        
    loader.load(
        "{% static 'frontend_static/assets/model/shirt_patten.glb' %}",
        (glb) => {
            model = glb.scene;
            model.scale.set(1, 1, 1);

            model.traverse((child) => {
                if (child.isMesh) {
                    if (child.material instanceof THREE.MeshStandardMaterial) {
                        const defaultTexture = new THREE.TextureLoader().load('{{imagepath}}');
                        child.material.map = defaultTexture;
                        child.material.side = THREE.DoubleSide;
                    }
                }
            });

            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            model.position.sub(center);

            scene.add(model);

            const boundingBox = new THREE.Box3().setFromObject(model);
            const boundingBoxCenter = boundingBox.getCenter(new THREE.Vector3());
            const boundingBoxSize = boundingBox.getSize(new THREE.Vector3());
            const maxDimension = Math.max(boundingBoxSize.x, boundingBoxSize.y, boundingBoxSize.z);

            camera.position.copy(boundingBoxCenter);
            camera.position.z += maxDimension * 2;

            controls.target.copy(boundingBoxCenter);
            controls.update();
        },
        (xhr) => {
            console.log((xhr.loaded / xhr.total) * 100 + '% loaded');
        },
        (error) => {
            console.error('Error loading 3D model', error);
        }
    );


    // Ambient Light
    function updateAmbientLight() {
        if (ambientLight) {
            scene.remove(ambientLight);
        }
        ambientLight = new THREE.AmbientLight(0xffffff, amblight); 
        scene.add(ambientLight);
    }
    
    ambientLight = new THREE.AmbientLight(0xffffff, amblight);
    scene.add(ambientLight);

    // Point Light
    const pointLight = new THREE.PointLight(0xffffff, 2);
    pointLight.position.set(5, 5, 5);
    scene.add(pointLight);

    // Directional Light
    const directionalLight = new THREE.DirectionalLight(0xffffff, 2);
    directionalLight.position.set(3, 3, 6);
    scene.add(directionalLight);

    // Spotlight
    const spotLight = new THREE.SpotLight(0xffffff, 2);
    spotLight.position.set(0, 10, 10);
    scene.add(spotLight);


    const sizes = {
        width: window.innerWidth,
        height: window.innerHeight,
    };

    const camera = new THREE.PerspectiveCamera(40, canvasWidth / canvasHeight, 1, 1000);
    camera.position.x = 5;
    camera.position.y = 5;
    camera.position.z = 5;

    scene.add(camera);

    const renderer = new THREE.WebGL1Renderer({ canvas });
    renderer.setSize(canvasWidth, canvasHeight);
    renderer.setPixelRatio(2);
    renderer.setClearColor(new THREE.Color('#ffffff'));
    renderer.render(scene, camera);

    const controls = new THREE.OrbitControls(camera, canvas);
    controls.enableDamping = true;
    controls.enablePan = false;
    controls.enableZoom = false;
    controls.autoRotate = true;
    controls.autoRotateSpeed = 5;

    window.addEventListener('resize', () => {
        const canvasWidth = canvasContainer.clientWidth;
        const canvasHeight = canvasContainer.clientHeight;
        camera.aspect = canvasWidth / canvasHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(canvasWidth, canvasHeight);
    });

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }

    animate();


    // Function to capture video
    function captureVideo(duration) {
        const canvas = document.querySelector('.webgl');
        const stream = canvas.captureStream(); // Capture canvas as stream
        const mediaRecorder = new MediaRecorder(stream);
        const chunks = [];

        mediaRecorder.ondataavailable = function(event) {
            chunks.push(event.data);
        };

        mediaRecorder.onstop = function() {
            const blob = new Blob(chunks, { 'type' : 'video/webm' });

            // Send the captured video to the server
            sendVideoToServer(blob);
        };

        mediaRecorder.start();

        // Stop capturing after the specified duration (in milliseconds)
        setTimeout(function() {
            mediaRecorder.stop();
        }, duration);
    }

    // Function to send the captured video to the server
    function sendVideoToServer(videoBlob) {
        const formData = new FormData();
        formData.append('video', videoBlob);


        fetch("{% url 'uploadVideoPage' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': window.CSRF_TOKEN  
            },
            body: formData
        })
        .then(response => {
            if (response.ok) {
                console.log('Video uploaded successfully');
                // Optionally, do something after video upload
            } else {
                console.error('Failed to upload video');
            }
        })
        .catch(error => {
            console.error('Error uploading video:', error);
        });
    }

    // Event listener for button click
    document.getElementById('capture-btn').addEventListener('click', function() {
        captureVideo(10000);
    });


</script>


{% endblock %}